---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: operator-validation
spec:
  params:
    - name: bundle_path
    - name: pyxis_url
      default: https://catalog.redhat.com/api/containers
  results:
    - name: package_name
      description: Operator package name
    - name: bundle_version
      description: Operator bundle version
    - name: max_supported_ocp_version
      description: Maximum version of OpenShift supported by this Operator
    - name: max_supported_index
      description: Pull spec for the index corresponding to the max OCP version
    - name: certification_project_id
      description: Identifier of certification project from Red Hat Connect
  workspaces:
    - name: source
  steps:
    - name: operator-sdk-validation
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        operator-sdk bundle validate $(params.bundle_path)
    - name: supported-version-check
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        set -xe

        VERSION_INFO=$(ocp-version-info $(params.bundle_path))
        echo $VERSION_INFO | jq
        echo $VERSION_INFO | jq -r '.max_version_index.ocp_version' | tee $(results.max_supported_ocp_version.path)
        echo $VERSION_INFO | jq -r '.max_version_index.path' | tee $(results.max_supported_index.path)

    - name: certification-project-check
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        echo "Checking availability of cert project identifier"

        PKG_PATH=$(dirname $(realpath $(params.bundle_path)))

        CI_FILE_PATH="$PKG_PATH/ci.yaml"

        CERT_PROJECT_ID=$(cat $CI_FILE_PATH | yq -r '.cert_project_id')

        if [ -z $CERT_PROJECT_ID ]; then
          echo "Certification project ID is missing in ci.yaml file (cert_project_id)"
          exit 1
        fi

        echo $CERT_PROJECT_ID | tee $(results.certification_project_id.path)

    - name: bundle-parse
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        set -xe

        BUNDLE_PATH=$(realpath $(params.bundle_path))

        echo -n $BUNDLE_PATH | rev | cut -d '/' -f 2 | tr -d $'\n' | rev | tee $(results.package_name.path)
        echo -n $BUNDLE_PATH | rev | cut -d '/' -f 1 | tr -d $'\n' | rev | tee $(results.bundle_version.path)
