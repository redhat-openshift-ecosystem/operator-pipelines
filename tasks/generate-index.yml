---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: generate-index
spec:
  params:
    - name: bundle_image
      description: Pull spec of a bundle image
    - name: from_index
      description: Parent index image the bundle will be added to
  results:
    - name: index_dockerfile
      description: Path to the generated index Dockerfile
  workspaces:
    - name: output
    - name: credentials
      description: Docker config for retrieving the parent index image and bundle image
  steps:
    - name: generate
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.output.path)
      script: |
        #! /usr/bin/env bash
        set -xe

        # OPM needs the standard docker config directory structure
        export DOCKER_CONFIG=/tmp/.docker
        mkdir $DOCKER_CONFIG
        cp $(workspaces.credentials.path)/.dockerconfigjson $DOCKER_CONFIG/config.json

        opm index add \
          --from-index "$(params.from_index)" \
          --bundles "$(params.bundle_image)" \
          --container-tool none \
          --out-dockerfile Dockerfile.index \
          --generate

        ls -lh
        cat Dockerfile.index
        echo -n Dockerfile.index | tee $(results.index_dockerfile.path)
