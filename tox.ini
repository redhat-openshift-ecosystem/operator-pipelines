[vars]
OPERATOR_MODULE = operatorcert
OPERATOR_TESTS = tests
MYPY_SOURCE_ARGS = --strict --ignore-missing-imports
MYPY_TEST_ARGS = {[vars]MYPY_SOURCE_ARGS}

[tox]
envlist = test,
          black,
          yamllint,
          bandit,
          pip-audit,
          mypy,
          pylint,
          hadolint,
          ansible-lint
skipsdist = True

[testenv]
deps =
    poetry
    poetry-plugin-export
commands_pre =
    poetry install
setenv =
    PYTHONPATH = {toxinidir}
extras = dev

[testenv:test]
commands = pytest -v \
       --cov {[vars]OPERATOR_MODULE} \
       --cov-report term-missing \
       --cov-fail-under 100 \
       --cov-report json \
       {posargs}

[testenv:black]
commands = black --check --diff .

[testenv:black-format]
commands = black .

[testenv:mypy]
commands = mypy {[vars]MYPY_SOURCE_ARGS} {[vars]OPERATOR_MODULE}
           mypy {[vars]MYPY_TEST_ARGS} {[vars]OPERATOR_TESTS}

[testenv:pylint]
commands = pylint {[vars]OPERATOR_MODULE} \
                  --min-similarity-lines 9 \
                  -d fixme

[testenv:yamllint]
basepython = python3.13
files =
    .
commands =
    yamllint {[testenv:yamllint]files}


[testenv:bandit]
commands = bandit -r operatorcert -ll

[testenv:pip-audit]
allowlist_externals = bash,python
commands = poetry export \
    --without-hashes \
    --format=requirements.txt -o /tmp/requirements.txt

    # run pip audit in a way it can't exit with non-zero status
    bash ./local-dev/pip-audit.sh
    # pip-audit does not support not failing on unfixable vulnerabilities, this hacks around that
    python ./local-dev/pip-audit-parse.py  /tmp/audit-output.json


[testenv:hadolint]
allowlist_externals = hadolint
commands = hadolint --failure-threshold warning \
           --info DL3013 --info DL3041 \
           Dockerfile

[testenv:pymarkdownlnt]
commands = pymarkdown scan .
           pymarkdown scan -r ansible docs

[testenv:ansible-lint]
allowlist_externals = ansible-lint, ansible-galaxy
commands = ansible-galaxy collection install -r ansible/playbooks/requirements.yml
           ansible-lint ansible/roles \
           --exclude ansible/roles/config_ocp_cluster/files \
           ansible/roles/index_signature_verification/files

# Tekton lint is experimental and may not be supported in the future.
# However, it is useful to have it here for now for manual testing.
# It is not included in the default testenv and is not triggered by the
# default tox command or Github Actions.
# To run it, use `tox -e tekton-lint`
# The linter doesn't support the tekton bundle yet, so it raises few false positives.
# The issue is tracked here: https://github.com/IBM/tekton-lint/issues/118
[testenv:tekton-lint]
allowlist_externals = npx
commands = npx @ibm/tekton-lint@latest
