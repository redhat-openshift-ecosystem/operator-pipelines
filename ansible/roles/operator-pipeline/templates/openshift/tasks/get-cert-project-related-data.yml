---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: get-cert-project-related-data
spec:
  params:
    - name: cert_project_id
      description: Identifier of certification project from Red Hat Connect
    - name: pyxis_cert_path
      default: ""
      description: Path to Pyxis certificates. Valid only when internal Pyxis is used.
    - name: pyxis_key_path
      default: ""
    - name: pyxis_url
      default: https://pyxis.engineering.redhat.com
  results:
    - name: isv_pid
      description: isv_pid of the certification project from Red Hat Connect
    - name: repo_name
      description: Repository name assigned to certification project from Red Hat Connect
    - name: operator_distribution
      description: Distribution method of the operator - either connect or marketplace
    - name: org_id
      description: Unique identifier of the organization in Red Hat Connect
    - name: github_usernames
      description: List of GitHub accounts with permissions allowing operator submission
    - name: certification_status
      description: Certification status of the cert Project
  workspaces:
    - name: pyxis-ssl-credentials
      optional: true
    - name: source
  steps:
    - name: get-cert-project-related-data
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      env:
        - name: PYXIS_CERT_PATH
          value: $(params.pyxis_cert_path)
        - name: PYXIS_KEY_PATH
          value: $(params.pyxis_key_path)
      script: |
        #! /usr/bin/env bash
        set -xe -o pipefail

        get-cert-project-related-data \
          --pyxis-url $(params.pyxis_url) \
          --cert-project-id $(params.cert_project_id)

        ORGANIZATION=$(cat config.yaml | yq -r '.organization')
        OPERATOR_DISTRIBUTION=$(cat cert_project | jq '.operator_distribution'| tr -d '"')
        case "$ORGANIZATION" in
          "certified-operators")
            if [ "$OPERATOR_DISTRIBUTION" != "connect" ]; then
              echo "This project is not permitted to distribute to the $ORGANIZATION catalog."
              exit 1
            fi
            ;;
          "redhat-marketplace")
            if [ "$OPERATOR_DISTRIBUTION" != "marketplace" ]; then
              echo "This project is not permitted to distribute to the $ORGANIZATION catalog."
              exit 1
            fi
            ;;
          *)
            echo "Invalid $ORGANIZATION"
            exit 1
            ;;
        esac

        CERTIFICATION_STATUS=$(cat cert_project | jq '.certification_status'| tr -d '"')
        if [ $CERTIFICATION_STATUS == "Started" ]; then
          echo -n "In Progress" | tee $(results.certification_status.path)
        fi

        # `grep .` ensures, that pipe fail if jq returns no results
        cat cert_project | jq '.container.isv_pid' | tr -d '"' | grep . | tr -d "\n" | tee $(results.isv_pid.path)
        cat cert_project | jq '.container.repository_name' | tr -d '"' | grep . | tr -d "\n" | tee $(results.repo_name.path)
        cat cert_project | jq '.org_id' | tr -d '"' |  tr -d '"' | grep . | tr -d "\n" | tee $(results.org_id.path)
        cat cert_project | jq '.container.github_usernames[]' | tr '\n' ' ' | tr -d '"' | grep . | tr -d "\n" | tee $(results.github_usernames.path)
        cat cert_project | jq '.operator_distribution' |  tr -d '"' | grep . | tr -d "\n" | tee $(results.operator_distribution.path)
