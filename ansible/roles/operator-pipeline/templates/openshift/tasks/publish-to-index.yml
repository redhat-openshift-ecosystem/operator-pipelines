---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: publish-to-index
spec:
  params:
    - name: pipeline_image
    - name: index_image_paths
      description: |
        Comma-separated list of index reference + manifest list digests generated by IIB
        builds, in the format of <from_index>+<temp_index_image>, example:
        registry.redhat.io/redhat/test-index:v4.6+registry-proxy.engineering.redhat.com/rh-osbs/iib@sha256:123
    - name: environment
      description: |
        Which environment the pipeline is running in. Can be one of [dev, qa, stage, prod]
    - name: operator_distribution_method
      description: Operator distribution method. Can be one of [connect, marketplace]
  steps:
    - name: skopeo-copy
      # Pipeline image is needed for Red Hat internal SSL cert
      image: "$(params.pipeline_image)"
      env:
        - name: QUAY_USER
          valueFrom:
            secretKeyRef:
              name: iib-quay-credentials
              key: username
        - name: QUAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: iib-quay-credentials
              key: password
        - name: DIST_METHOD
          value: "$(params.operator_distribution_method)"
      script: |
        #! /usr/bin/env bash
        # DO NOT USE `set -x`, to avoid revealing the quay token in logs!
        set -e

        # select the correct index
        case "$(params.environment)" in
            prod)
                case $DIST_METHOD in
                    connect)
                      FROM_INDEX="quay.io/redhat/redhat----certified-operator-index"
                    ;;
                    marketplace)
                      FROM_INDEX="quay.io/redhat/redhat----redhat-marketplace-index"
                    ;;
                    *)
                      echo "Unknown value for operator_distribution_method: $DIST_METHOD"
                      exit 1
                    ;;
                esac
            ;;
            stage | integration-tests)
                case $DIST_METHOD in
                    connect)
                      FROM_INDEX="quay.io/redhat-pending/redhat----certified-operator-index"
                    ;;
                    marketplace)
                      FROM_INDEX="quay.io/redhat-pending/redhat----redhat-marketplace-index"
                    ;;
                    *)
                      echo "Unknown value for operator_distribution_method: $DIST_METHOD"
                      exit 1
                    ;;
                esac
            ;;
            *)
                echo "Publishing bundle to an index is a NOOP for dev and qa environments at this time."
                exit 0
            ;;
        esac

        echo "FROM_INDEX: $FROM_INDEX"
        echo "Copying index images to published repos..."

        TEMP_IMAGES=$(echo $(params.index_image_paths) | tr "," " ")

        for i in $TEMP_IMAGES
        do
          SRC_IMAGE=$(echo $i | awk -F '+' '{print $2}')
          echo "Source image: $SRC_IMAGE"
          VERSION=$(echo $i | awk -F '+' '{print $1}' | awk -F ':' '{print $2}')
          DEST_IMAGE="${FROM_INDEX}:${VERSION}"
          echo "Dest image: $DEST_IMAGE"

          skopeo \
            --command-timeout 300s copy \
            --format v2s2 --all \
            --src-no-creds \
            --dest-creds $QUAY_USER:$QUAY_TOKEN \
            docker://$SRC_IMAGE \
            docker://$DEST_IMAGE
        done
