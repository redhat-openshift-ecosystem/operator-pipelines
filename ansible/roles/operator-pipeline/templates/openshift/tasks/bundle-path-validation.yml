---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: bundle-path-validation
spec:
  params:
    - name: pipeline_image
    - name: bundle_path
      description: path indicating the location of the Operator bundle within the repository
  results:
    - name: package_name
      description: Operator package name
    - name: package_path
      description: Path to the operator package
    - name: bundle_version
      description: Operator bundle version
    - name: operators_path
      description: Path to the operators directory
    - name: catalog_repo_path
      description: Path to the catalog repository containing the operators directory
  workspaces:
    - name: source
  steps:
    - name: bundle-parse
      image: "$(params.pipeline_image)"
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        set -xe

        BUNDLE_PATH=$(realpath $(params.bundle_path))

        echo -n "$BUNDLE_PATH" | rev | cut -d '/' -f 2 | tr -d $'\n' | rev | tee "$(results.package_name.path)"
        echo -n "$BUNDLE_PATH" | rev | cut -d '/' -f 1 | tr -d $'\n' | rev | tee "$(results.bundle_version.path)"
        dirname "$BUNDLE_PATH" | tr -d $'\n' | tee "$(results.package_path.path)"

        # Extract operators path by removing the last 2 directory entries (operator_name/version)
        OPERATORS_PATH=$(echo -n "$BUNDLE_PATH" | rev | cut -d '/' -f 3- | rev | tr -d $'\n')
        echo -n "$OPERATORS_PATH" | tee "$(results.operators_path.path)"

        # Extract catalog repo path as parent of operators path
        dirname "$OPERATORS_PATH" | tr -d $'\n' | tee "$(results.catalog_repo_path.path)"
