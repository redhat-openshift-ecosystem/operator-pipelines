---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-static-tests
spec:
  description: Run the static test suite against a given bundle.

  params:
    - name: pipeline_image
      description: The common pipeline image.

    - name: pull_request_url
      description: URL to Github pull request with a new bundle submission.

    - name: operator_name
      description: Name of the operator under test.

    - name: bundle_version
      description: Version of the bundle under test.

    - name: affected_catalog_operators
      description: All catalog operators affected with the change.

    - name: github_host_url
      description: |
        The GitHub host, adjust this if you run a GitHub enterprise.
      default: "https://api.github.com"

    - name: github_token_secret_key
      description: The key within the Kubernetes Secret that contains the GitHub token.
      default: token

    - name: github_token_secret_name
      description: The name of the Kubernetes Secret that contains the GitHub token.
      default: github

    - name: test_suites
      description: A comma separate list of paths to a test suite that is executed

    - name: bundle_path

  results:
    - name: messages_count
      description: Number of messages generated by the tests (failures+warnings)

    - name: failures_count
      description: Number of failures generated by the tests

  workspaces:
    - name: source
      description: Clone of the repo

    - name: output
      description: Storage for the results file (json)

  steps:
    - name: run-suite
      image: "$(params.pipeline_image)"
      workingDir: $(workspaces.source.path)
      env:
        - name: GH_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.github_token_secret_name)
              key: $(params.github_token_secret_key)
      script: |
        #!/usr/bin/env bash
        set -xe

        if [ -z "$(params.bundle_path)" ] && [ -z "$(params.affected_catalog_operators)" ]; then
          echo "No bundle or catalog added/changed, skipping tests"
          echo -n "" | tee $(results.messages_count.path)
          echo -n "" | tee $(results.failures_count.path)
          exit 0
        fi

        EXTRA_ARGS=""

        # Get labels from the pull request
        gh pr view "$(params.pull_request_url)" --json labels > labels.json

        # Following command filters out labels that start with prefix and merge them to single string separated by comma
        SKIP_TESTS=`jq -r '.labels[] | select(.name | startswith("tests/skip")) | .name' labels.json | paste -sd "," |sed 's/tests\/skip\///g'`

        if [[ $SKIP_TESTS != "" ]]; then
          echo "Following tests are skipped: $SKIP_TESTS"
          EXTRA_ARGS+=" --skip-tests $SKIP_TESTS"
        fi

        JSON_RESULTS_FILE="$(workspaces.output.path)/static-test-results.json"

        static-tests --verbose \
          --output-file "$JSON_RESULTS_FILE" \
          --repo-path "$(workspaces.source.path)" \
          --suites "$(params.test_suites)" $EXTRA_ARGS \
          "$(params.operator_name)" "$(params.bundle_version)" \
          "$(params.affected_catalog_operators)"

        jq . <$JSON_RESULTS_FILE
        jq -r '(.outputs//[])|length' <$JSON_RESULTS_FILE \
          | tr -d '\r\n' >$(results.messages_count.path)
        jq -r '[(.outputs//[])[]|select(.type=="error")]|length' <$JSON_RESULTS_FILE \
          | tr -d '\r\n' >$(results.failures_count.path)

    - name: build-and-post-comment
      image: "$(params.pipeline_image)"
      workingDir: "$(workspaces.output.path)"
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: "$(params.github_token_secret_name)"
              key: "$(params.github_token_secret_key)"
      script: |
        #!/usr/bin/env bash
        set -xe

        MESSAGE_COUNT=$(cat $(results.messages_count.path))

        # If there are no messages, exit
        [ -z "$MESSAGE_COUNT" ] || [ "$MESSAGE_COUNT" -eq 0 ] && exit 0

        JSON_RESULTS_FILE="$(workspaces.output.path)/static-test-results.json"
        MESSAGE_FILE="$(workspaces.output.path)/static-test-results.md"

        echo '# Static test results' >$MESSAGE_FILE
        echo >>$MESSAGE_FILE
        echo '|Status|Check|Message|' >>$MESSAGE_FILE
        echo '|:----:|:----|:------|' >>$MESSAGE_FILE

        jq -r '(.outputs//[])[]|"|\(.type)|\(.check)|\(.message|gsub("\n";" "))|"' \
          <$JSON_RESULTS_FILE >>$MESSAGE_FILE
        echo >>$MESSAGE_FILE

        # Replace status words with corresponding symbols
        sed -ie 's/^|warning|/|:warning:|/g;s/^|error|/|:x:|/g' "$MESSAGE_FILE"

        echo "Posting GitHub comment to issue (or PR) $(params.pull_request_url)"

        github-add-comment \
          --github-host-url "$(params.github_host_url)" \
          --request-url "$(params.pull_request_url)" \
          --comment-file "$(workspaces.output.path)/static-test-results.md"

    - name: check-for-failures
      image: "$(params.pipeline_image)"
      workingDir: "$(workspaces.output.path)"
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: "$(params.github_token_secret_name)"
              key: "$(params.github_token_secret_key)"
      script: |
        #!/usr/bin/env bash
        set -xe

        FAILURE_COUNT=$(cat $(results.failures_count.path))

        if [ -z "$FAILURE_COUNT" ] || [ "$FAILURE_COUNT" -eq 0 ] ; then
          github-labels --pull-request-url "$(params.pull_request_url)" \
            --remove-labels validation-failed
        else
          github-labels --pull-request-url "$(params.pull_request_url)" \
            --add-labels validation-failed
          echo "Static tests failed! A summary was added to the PR."
          exit 1
        fi
