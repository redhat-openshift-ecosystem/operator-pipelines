---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-static-tests
spec:
  description: Run the static test suite against a given bundle.

  params:
    - name: pipeline_image
      description: The common pipeline image.

    - name: operator_name
      description: Name of the operator under test.

    - name: bundle_version
      description: Version of the bundle under test.

  results:
    - name: messages_count
      description: Number of messages generated by the tests (failures+warnings)

    - name: failures_count
      description: Number of failures generated by the tests

  workspaces:
    - name: source
      description: Clone of the repo

    - name: output
      description: Storage for the results file (json)

  steps:
    - name: run-suite
      image: "$(params.pipeline_image)"
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -xe

        JSON_RESULTS_FILE="$(workspaces.output.path)/static-test-results.json"

        static-tests --verbose                                  \
          --output-file "$JSON_RESULTS_FILE"                    \
          --repo-path "$(workspaces.source.path)"               \
          "$(params.operator_name)" "$(params.bundle_version)"

        jq . <$JSON_RESULTS_FILE
        jq -r '(.outputs//[])|length' <$JSON_RESULTS_FILE \
          | tr -d '\r\n' >$(results.messages_count.path)
        jq -r '[(.outputs//[])[]|select(.type=="error")]|length' <$JSON_RESULTS_FILE \
          | tr -d '\r\n' >$(results.failures_count.path)
