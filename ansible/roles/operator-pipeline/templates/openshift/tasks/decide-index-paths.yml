---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: decide-index-paths
spec:
  description: |-
    This task checks output of the two previous tasks (add-bundle-to-index
    and add-fbc-fragments-to-index) which are mutually exclusive.
    Uses existing output as a result to be used by following tasks.
  params:
    - name: pipeline_image
  results:
    - name: index_image_paths
      description: Comma-separated list of index reference + temporary location of the unpublished images generated by IIB builds

  workspaces:
    - name: input
  steps:
    - name: decide-paths
      image: "$(params.pipeline_image)"
      workingDir: $(workspaces.input.path)
      script: |
        #! /usr/bin/env bash
        set -xe

        echo "Checking which build actually ran, FBC change or operator/bundle change."

        BUILD="$(workspaces.input.path)/index-image-paths.txt"
        FBC_BUILD="$(workspaces.input.path)/fbc-index-image-paths.txt"
        INDEX_IMAGE_PATHS="$(results.index_image_paths.path)"

        if [[ -f $BUILD ]]; then
          echo "Using bundle build results"
          cat $BUILD | tee $INDEX_IMAGE_PATHS
        elif [[ -f $FBC_BUILD ]]; then
          echo "Using FBC build results"
          cat $FBC_BUILD | tee $INDEX_IMAGE_PATHS
        else
          echo "Error: Index image paths not found"
          exit 1
        fi
