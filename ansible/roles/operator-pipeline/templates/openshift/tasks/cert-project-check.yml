---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: certification-project-check
spec:
  params:
    - name: bundle_path
      description: path indicating the location of the certified bundle within the repository
    - name: pyxis_cert_path
      default: ""
      description: Path to Pyxis certificates. Valid only when internal Pyxis is used.
    - name: pyxis_key_path
      default: ""
    - name: pyxis_url
      default: https://pyxis.engineering.redhat.com
  results:
    - name: certification_project_id
      description: Identifier of certification project from Red Hat Connect
    - name: isv_pid
      description: isv_pid of the certification project from Red Hat Connect
  workspaces:
    - name: source
    - name: pyxis-ssl-credentials
      optional: false
  steps:
    - name: certification-project-check
      image: quay.io/redhat-isv/operator-pipelines-images:latest
      workingDir: $(workspaces.source.path)
      script: |
        #! /usr/bin/env bash
        echo "Checking availability of cert project identifier"

        PKG_PATH=$(dirname $(realpath $(params.bundle_path)))

        CI_FILE_PATH="$PKG_PATH/ci.yaml"

        CERT_PROJECT_ID=$(cat $CI_FILE_PATH | yq -r '.cert_project_id')

        if [ -z $CERT_PROJECT_ID ]; then
          echo "Certification project ID is missing in ci.yaml file (cert_project_id)"
          exit 1
        fi

        PROJECT_URL="$(params.pyxis_url)/v1/projects/certification/id/$CERT_PROJECT_ID"
        # TODO refactor to use Python script
        PROJECT=$(curl -k -X GET $PROJECT_URL -H  "accept: application/json" --cert $(params.pyxis_cert_path) --key $(params.pyxis_key_path))

        ISV_PID=$(echo $PROJECT | jq -r '.container.isv_pid')

        if [ -z $ISV_PID ]; then
          echo "Certification project isv_pid not found."
          exit 1
        fi

        echo -n $CERT_PROJECT_ID | tee $(results.certification_project_id.path)
        echo -n $ISV_PID | tee $(results.isv_pid.path)
