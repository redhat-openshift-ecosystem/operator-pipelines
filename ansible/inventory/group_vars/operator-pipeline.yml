---
##### General settings
ansible_connection: local
ansible_python_interpreter: /usr/bin/python3
env: unset
oc_namespace: "operator-pipeline-{{ env }}"
oc_signing_namespace: "signing-pipeline-{{ env }}"
oc_index_bootstrap_namespace: "index-bootstrap-{{ env }}"
service_account_name: operator-pipeline-admin
branch: "{{ env }}"
preflight_trigger_environment: preprod

operator_pipeline_image_repo: quay.io/redhat-isv/operator-pipelines-images
operator_pipeline_image_tag: latest
operator_pipeline_image_pull_spec: "{{ operator_pipeline_image_repo }}:{{ operator_pipeline_image_tag }}"
operator_pipeline_pending_namespace: "operator-pipeline-{{ env }}"

operator_pipeline_base_url: "apps.pipelines-stage.0ce8.p1.openshiftapps.com"

tekton_pruner_keep: 10

##### Secrets locations
operator_pipeline_private_key_local_path: ../../vaults/{{ env }}/operator-pipeline.key
operator_pipeline_private_cert_local_path: ../../vaults/{{ env }}/operator-pipeline.pem

operator_hosted_pipeline_registry_auth_path: ../../vaults/{{ env }}/registry-auth/hosted-pipeline.json
operator_release_pipeline_registry_auth_pull_path: ../../vaults/{{ env }}/registry-auth/release-pipeline-pull.json
operator_release_pipeline_registry_auth_push_path: ../../vaults/{{ env }}/registry-auth/release-pipeline-push.json
operator_release_pipeline_registry_auth_serve_path: ../../vaults/{{ env }}/registry-auth/release-pipeline-serve.json

operator_pipeline_kubeconfig_prow_local_path: ../../vaults/common/kubeconfig-prow
operator_pipeline_github_bot_token: ../../vaults/common/github-bot-token.txt

operator_pipeline_hydra_sso_token_url: https://auth.stage.redhat.com/auth/realms/EmployeeIDP/protocol/openid-connect/token
operator_pipeline_hydra_sso_client_id_local_path: ../../vaults/common/nonprod-hydra-sso-client-id
operator_pipeline_hydra_sso_client_secret_local_path: ../../vaults/common/nonprod-hydra-sso-client-secret

operator_pipeline_preflight_decryption_key_private_local_path: ../../vaults/common/preflight-decryption-key-priv.gpg
operator_pipeline_preflight_decryption_key_public_local_path: ../../vaults/common/preflight-decryption-key-pub

operator_pipeline_gpg_key_path: ../../vaults/{{ env }}/operator-pipeline-gpg.key
operator_pipeline_gpg_passphrase_path: ../../vaults/{{ env }}/operator-pipeline-gpg.passphrase

# SSH key for the operator pipeline bot to access git repositories
operator_pipeline_bot_ssh_key_path: ../../vaults/common/github-bot-ssh

operator_pipeline_webhook_dispatcher_base_url: "https://webhook-dispatcher-{{ oc_namespace }}.{{ operator_pipeline_base_url }}"
operator_pipeline_webhook_dispatcher_url: "{{ operator_pipeline_webhook_dispatcher_base_url }}/api/v1/webhooks/github-pipeline"
operator_pipeline_webhook_secret: ../../vaults/common/github-webhook-secret-preprod.txt

kerberos_keytab_isv: ../../vaults/common/nonprod-operatorpipelines.keytab
kerberos_keytab_isv_pending: ../../vaults/common/nonprod-operatorpipelines-pending.keytab
kerberos_keytab_community: ../../vaults/common/nonprod-community-operatorpipelines.keytab
kerberos_keytab_community_pending: ../../vaults/common/nonprod-community-operatorpipelines-pending.keytab

index_img_signing_pipeline_private_key_local_path: ../../vaults/{{ env }}/community-operator-signing-pipeline.key
index_img_signing_pipeline_private_cert_local_path: ../../vaults/{{ env }}/community-operator-signing-pipeline.pem

index_img_bootstrap_signing_pipeline_registry_auth_path: ../../vaults/common/nonprod-index-bootstrap-signing-pipeline.json


community_operator_hosted_pipeline_registry_auth_path: ../../vaults/{{ env }}/registry-auth/community-hosted-pipeline.json
community_operator_pipeline_pending_namespace: "community-operator-pipeline-{{ env }}"

signing_pub_key_local_path: ../../vaults/{{ env }}/sig-key.pub

# Webhook dispatcher
operator_pipeline_webhook_dispatcher_config_file: ../../vaults/common/webhook-dispatcher-config.yml
operator_pipeline_dispatcher_hosted_pipeline_events:
  - labeled
  - opened
  - reopened
  - synchronize
  - ready_for_review
operator_pipeline_dispatcher_release_pipeline_events:
  - labeled
  - closed

operator_pipeline_dispatcher_hosted_capacity: 5
operator_pipeline_dispatcher_release_capacity: 5

operator_pipeline_callback_url: "https://operator-pipeline-{{ oc_namespace }}.{{ operator_pipeline_base_url}}"
operator_pipeline_community_pipeline_callback_url: "https://community-operator-pipeline-{{ oc_namespace }}.{{ operator_pipeline_base_url }}"

operator_pipeline_certified_operators_repository_name: "redhat-openshift-ecosystem/certified-operators-preprod"
operator_pipeline_marketplace_operators_repository_name: "redhat-openshift-ecosystem/redhat-marketplace-operators-preprod"
operator_pipeline_community_operators_repository_name: "redhat-openshift-ecosystem/community-operators-pipeline-preprod"

operator_pipeline_hosted_pipeline_cel_filter: >-
  (
    (
      body.action in ["opened", "reopened", "synchronize", "ready_for_review"]
      && body.pull_request.base.ref == "{{ branch }}"
    ) ||
    (
      body.action == "labeled"
      && body.label.name == "pipeline/trigger-hosted"
      && body.pull_request.base.ref == "{{ branch }}"
    )
  )

operator_pipeline_release_pipeline_cel_filter: >-
  (
    (
      body.action == "closed"
      && body.pull_request.base.ref == "{{ branch }}"
      && body.pull_request.merged == true
    ) ||
    (
      body.action == "labeled"
      && body.label.name == "pipeline/trigger-release"
      && body.pull_request.base.ref == "{{ branch }}"
      && body.pull_request.merged == true
    )
  )

operator_pipeline_dispatcher_config:
  - name: Hosted pipeline for certified operators
    events: "{{ operator_pipeline_dispatcher_hosted_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_certified_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-hosted-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_hosted_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_hosted_pipeline_cel_filter | replace('\n', '') }}"

  - name: Release pipeline for certified operators
    events: "{{ operator_pipeline_dispatcher_release_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_certified_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-release-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_release_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_release_pipeline_cel_filter | replace('\n', '') }}"

  - name: Hosted pipeline for marketplace operators
    events: "{{ operator_pipeline_dispatcher_hosted_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_marketplace_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-hosted-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_hosted_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_hosted_pipeline_cel_filter | replace('\n', '') }}"

  - name: Release pipeline for marketplace operators
    events: "{{ operator_pipeline_dispatcher_release_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_marketplace_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-release-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_release_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_release_pipeline_cel_filter | replace('\n', '') }}"

  - name: Hosted pipeline for community operators
    events: "{{ operator_pipeline_dispatcher_hosted_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_community_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-hosted-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_hosted_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_community_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_hosted_pipeline_cel_filter | replace('\n', '') }}"

  - name: Release pipeline for community operators
    events: "{{ operator_pipeline_dispatcher_release_pipeline_events }}"
    full_repository_name: "{{ operator_pipeline_community_operators_repository_name }}"
    capacity:
      type: ocp_tekton
      pipeline_name: "operator-release-pipeline"
      max_capacity: "{{ operator_pipeline_dispatcher_release_capacity }}"
      namespace: "{{ oc_namespace }}"
    callback_url: "{{ operator_pipeline_community_pipeline_callback_url }}"
    filter:
      cel_expression: "{{ operator_pipeline_release_pipeline_cel_filter | replace('\n', '') }}"
